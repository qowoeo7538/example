[TOC]

## 1 原理

线程甲从主内存中拷贝了变量A为1，在自己的线程中将副本A改为了10，当线程甲准备把这个变量更新到主内存时，如果主内存A的值不改变（期望值），还是1，那么线程甲成功更新主内存中A的值。但如果主内存A的值已经先被其他线程改掉不为1，那么线程甲不断地重试，直到成功为止（自旋）。

## 2 ABA问题

一个变量初次读取的时候是 A 值，它的值被改成了 B，后来又被改回为 A，那 CAS 操作就会误认为它从来没有被改变过，解决方案：

1. 互斥同步锁synchronized
2. 如果项目只在乎数值是否正确， 那么ABA 问题不会影响程序并发的正确性。
3. J.U.C 包提供了一个带有时间戳的原子引用类 `AtomicStampedReference` 来解决该问题，它通过**控制变量的版本**来保证 CAS 的正确性。